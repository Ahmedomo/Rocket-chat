#!/bin/bash

# Obtain siteurl value
siteurl="$(snapctl get siteurl)"
# Validate it
siteurl_regex='^https?:\/\/([0-9A-Za-z\.-]{1,})?(\.[a-z\.]{2,6})?([\/\da-z\.-]+)?$'
if ! [[ $siteurl =~ $siteurl_regex ]] ; then
    echo "\"$siteurl\" is not a valid url" >&2
    exit 1
fi

# Obtain port value
port="$(snapctl get port)"
# Validate it
port_regex='^([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$'
if ! [[ $port =~ $port_regex ]]; then
    echo "\"$port\" is not a valid port" >&2
    exit 1
fi

# Obtain mongourl value
mongourl="$(snapctl get mongourl)"
# Validate it
mongourl_regex='^mongodb:\/\/([0-9A-Za-z\.-]{1,})?(\.[a-z\.]{2,6})?:([0-9]{2,5})?\/parties$'
if ! [[ $mongourl =~ $mongourl_regex ]] ; then
    echo "\"$mongourl\" is not a valid url" >&2
    exit 1
fi


# Obtain mongooplogurl value
mongooplogurl="$(snapctl get mongooplogurl)"
# Validate it
mongooplogurl_regex='^mongodb:\/\/([0-9A-Za-z\.-]+)?(\.[a-z\.]{2,6})?:([0-9]{2,5})?\/local$'
if ! [[ $mongooplogurl =~ $mongooplogurl_regex ]] ; then
    echo "\"$mongooplogurl\" is not a valid url" >&2
    exit 1
fi

# Obtain site protocol
https="$(snapctl get https)"
# Validate it
https_regex='((enable)|(disable))'
if ! [[ $https =~ $https_regex ]]; then
    echo "\"$https\" should be enable or disable" >&2
    exit 1
else
  if [[ $https == enable ]] && [[ $siteurl =~ ^http: ]] ; then
    echo "Error: You enabled https but your site URL starts with http, disabling https ..."
    snapctl set https=disable
    exit 1
  elif [[ $https == enable ]] && [[ $siteurl =~ ^https: ]] ; then
    domain=${siteurl#"https://"}
    domain=${domain%%/*}
    pubip=$(dig $domain |grep -A1 ";; ANSWER SECTION:" |tail -1 | awk '{print $5}')
    if ! [ -z "$pubip" ] ; then
      echo "Error: Can't resove DNS query for $domain, check your DNS configuration, disabling https ..."
      snapctl set https=disable
      exit 1
    fi
  fi
fi

