stages:
  - build
  - deploy

build:
  image: node:latest
  stage: build
  artifacts:
    paths:
      - dist
  script:
    - if [ ! -e "$HOME/.meteor/meteor" ]; then curl https://install.meteor.com | sed s/--progress-bar/-sL/g | /bin/sh; fi
    - export PATH="$HOME/.meteor:$PATH" && scripts/build.sh

deploy_development:
  image: python:latest
  environment: development
  stage: deploy
  dependencies:
    - build
  variables:
    AWS_REGION: us-west-2
    AWS_DEFAULT_REGION: us-west-2
  script:
    - pip install awscli
    - aws s3 cp dist/lookamo.chat.tar.gz s3://lookamo-maintenance-dev/lookamo.chat-dist/lookamo.chat.tar.gz
    - export AWS_REGION=sa-east-1 && export AWS_DEFAULT_REGION=us-east-1 && scripts/deploy.sh 7b7a33ea-84d1-4100-b5db-770d87c7db24 03a4fd55-b34c-4cfc-acc9-53726b126387
  only:
    - lookamo-development

deploy_production:
  image: python:latest
  environment: production
  stage: deploy
  dependencies:
    - build
  variables:
    AWS_REGION: us-west-2
    AWS_DEFAULT_REGION: us-west-2
  script:
    - pip install awscli
    - aws s3 cp dist/lookamo.chat.tar.gz s3://lookamo-maintenance-prod/lookamo.chat-dist/lookamo.chat.tar.gz
    - export AWS_REGION=sa-east-1 && export AWS_DEFAULT_REGION=us-east-1 && scripts/deploy.sh 76dd1987-5b3c-4b53-bdc2-835064b6a928 c709d2ba-50a1-47b0-aa87-494e42b3db21
  only:
    - lookamo
