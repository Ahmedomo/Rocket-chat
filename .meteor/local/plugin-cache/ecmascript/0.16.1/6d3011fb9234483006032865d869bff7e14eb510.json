{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/notifications/desktop.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/lib/server/functions/notifications/desktop.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/notifications/desktop.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/notifications/desktop.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/notifications/desktop.js"}},"code":"module.export({\n  notifyDesktopUser: () => notifyDesktopUser,\n  shouldNotifyDesktop: () => shouldNotifyDesktop\n});\nlet roomCoordinator;\nmodule.link(\"../../../../../server/lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n\n}, 0);\nlet api;\nmodule.link(\"../../../../../server/sdk/api\", {\n  api(v) {\n    api = v;\n  }\n\n}, 1);\nlet metrics;\nmodule.link(\"../../../../metrics/server\", {\n  metrics(v) {\n    metrics = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\n\nfunction notifyDesktopUser(_ref) {\n  var _roomCoordinator$getR;\n\n  let {\n    userId,\n    user,\n    message,\n    room,\n    duration,\n    notificationMessage\n  } = _ref;\n  const {\n    title,\n    text\n  } = (_roomCoordinator$getR = roomCoordinator.getRoomDirectives(room.t)) === null || _roomCoordinator$getR === void 0 ? void 0 : _roomCoordinator$getR.getNotificationDetails(room, user, notificationMessage, userId);\n  const payload = {\n    title,\n    text,\n    duration,\n    payload: {\n      _id: message._id,\n      rid: message.rid,\n      tmid: message.tmid,\n      sender: message.u,\n      type: room.t,\n      name: room.name,\n      message: {\n        msg: message.msg,\n        t: message.t\n      }\n    }\n  };\n  metrics.notificationsSent.inc({\n    notification_type: 'desktop'\n  });\n  api.broadcast('notify.desktop', userId, payload);\n}\n\nfunction shouldNotifyDesktop(_ref2) {\n  let {\n    disableAllMessageNotifications,\n    status,\n    statusConnection,\n    desktopNotifications,\n    hasMentionToAll,\n    hasMentionToHere,\n    isHighlighted,\n    hasMentionToUser,\n    hasReplyToThread,\n    roomType,\n    isThread\n  } = _ref2;\n\n  if (disableAllMessageNotifications && desktopNotifications == null && !isHighlighted && !hasMentionToUser && !hasReplyToThread) {\n    return false;\n  }\n\n  if (statusConnection === 'offline' || status === 'busy' || desktopNotifications === 'nothing') {\n    return false;\n  }\n\n  if (!desktopNotifications) {\n    if (settings.get('Accounts_Default_User_Preferences_desktopNotifications') === 'all' && (!isThread || hasReplyToThread)) {\n      return true;\n    }\n\n    if (settings.get('Accounts_Default_User_Preferences_desktopNotifications') === 'nothing') {\n      return false;\n    }\n  }\n\n  return (roomType === 'd' || !disableAllMessageNotifications && (hasMentionToAll || hasMentionToHere) || isHighlighted || desktopNotifications === 'all' || hasMentionToUser) && (!isThread || hasReplyToThread);\n}","map":{"version":3,"sources":["app/lib/server/functions/notifications/desktop.js"],"names":["module","export","notifyDesktopUser","shouldNotifyDesktop","roomCoordinator","link","v","api","metrics","settings","userId","user","message","room","duration","notificationMessage","title","text","getRoomDirectives","t","getNotificationDetails","payload","_id","rid","tmid","sender","u","type","name","msg","notificationsSent","inc","notification_type","broadcast","disableAllMessageNotifications","status","statusConnection","desktopNotifications","hasMentionToAll","hasMentionToHere","isHighlighted","hasMentionToUser","hasReplyToThread","roomType","isThread","get"],"mappings":"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","sourcesContent":["import { roomCoordinator } from '../../../../../server/lib/rooms/roomCoordinator';\nimport { api } from '../../../../../server/sdk/api';\nimport { metrics } from '../../../../metrics/server';\nimport { settings } from '../../../../settings/server';\n\n/**\n * Send notification to user\n *\n * @param {string} userId The user to notify\n * @param {object} user The sender\n * @param {object} room The room send from\n * @param {object} message The message object\n * @param {number} duration Duration of notification\n * @param {string} notificationMessage The message text to send on notification body\n */\nexport function notifyDesktopUser({ userId, user, message, room, duration, notificationMessage }) {\n\tconst { title, text } = roomCoordinator.getRoomDirectives(room.t)?.getNotificationDetails(room, user, notificationMessage, userId);\n\n\tconst payload = {\n\t\ttitle,\n\t\ttext,\n\t\tduration,\n\t\tpayload: {\n\t\t\t_id: message._id,\n\t\t\trid: message.rid,\n\t\t\ttmid: message.tmid,\n\t\t\tsender: message.u,\n\t\t\ttype: room.t,\n\t\t\tname: room.name,\n\t\t\tmessage: {\n\t\t\t\tmsg: message.msg,\n\t\t\t\tt: message.t,\n\t\t\t},\n\t\t},\n\t};\n\n\tmetrics.notificationsSent.inc({ notification_type: 'desktop' });\n\n\tapi.broadcast('notify.desktop', userId, payload);\n}\n\nexport function shouldNotifyDesktop({\n\tdisableAllMessageNotifications,\n\tstatus,\n\tstatusConnection,\n\tdesktopNotifications,\n\thasMentionToAll,\n\thasMentionToHere,\n\tisHighlighted,\n\thasMentionToUser,\n\thasReplyToThread,\n\troomType,\n\tisThread,\n}) {\n\tif (disableAllMessageNotifications && desktopNotifications == null && !isHighlighted && !hasMentionToUser && !hasReplyToThread) {\n\t\treturn false;\n\t}\n\n\tif (statusConnection === 'offline' || status === 'busy' || desktopNotifications === 'nothing') {\n\t\treturn false;\n\t}\n\n\tif (!desktopNotifications) {\n\t\tif (settings.get('Accounts_Default_User_Preferences_desktopNotifications') === 'all' && (!isThread || hasReplyToThread)) {\n\t\t\treturn true;\n\t\t}\n\t\tif (settings.get('Accounts_Default_User_Preferences_desktopNotifications') === 'nothing') {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn (\n\t\t(roomType === 'd' ||\n\t\t\t(!disableAllMessageNotifications && (hasMentionToAll || hasMentionToHere)) ||\n\t\t\tisHighlighted ||\n\t\t\tdesktopNotifications === 'all' ||\n\t\t\thasMentionToUser) &&\n\t\t(!isThread || hasReplyToThread)\n\t);\n}\n"]},"sourceType":"module","hash":"6d3011fb9234483006032865d869bff7e14eb510"}
