{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/v1/videoCall.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/livechat/server/api/v1/videoCall.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/v1/videoCall.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/v1/videoCall.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/api/v1/videoCall.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 2);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 3);\nlet Messages, Rooms;\nmodule.link(\"../../../../models\", {\n  Messages(v) {\n    Messages = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  }\n\n}, 4);\nlet rcSettings;\nmodule.link(\"../../../../settings/server\", {\n  settings(v) {\n    rcSettings = v;\n  }\n\n}, 5);\nlet API;\nmodule.link(\"../../../../api/server\", {\n  API(v) {\n    API = v;\n  }\n\n}, 6);\nlet findGuest, getRoom, settings;\nmodule.link(\"../lib/livechat\", {\n  findGuest(v) {\n    findGuest = v;\n  },\n\n  getRoom(v) {\n    getRoom = v;\n  },\n\n  settings(v) {\n    settings = v;\n  }\n\n}, 7);\nlet OmnichannelSourceType;\nmodule.link(\"../../../../../definition/IRoom\", {\n  OmnichannelSourceType(v) {\n    OmnichannelSourceType = v;\n  }\n\n}, 8);\nlet hasPermission, canSendMessage;\nmodule.link(\"../../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  },\n\n  canSendMessage(v) {\n    canSendMessage = v;\n  }\n\n}, 9);\nlet Livechat;\nmodule.link(\"../../lib/Livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 10);\nlet Logger;\nmodule.link(\"../../../../logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 11);\nconst logger = new Logger('LivechatVideoCallApi');\nAPI.v1.addRoute('livechat/video.call/:token', {\n  get() {\n    try {\n      check(this.urlParams, {\n        token: String\n      });\n      check(this.queryParams, {\n        rid: Match.Maybe(String)\n      });\n      const {\n        token\n      } = this.urlParams;\n      const guest = findGuest(token);\n\n      if (!guest) {\n        throw new Meteor.Error('invalid-token');\n      }\n\n      const rid = this.queryParams.rid || Random.id();\n      const roomInfo = {\n        jitsiTimeout: new Date(Date.now() + 3600 * 1000),\n        source: {\n          type: OmnichannelSourceType.API,\n          alias: 'video-call'\n        }\n      };\n      const {\n        room\n      } = getRoom({\n        guest,\n        rid,\n        roomInfo\n      });\n      const config = Promise.await(settings());\n\n      if (!config.theme || !config.theme.actionLinks || !config.theme.actionLinks.jitsi) {\n        throw new Meteor.Error('invalid-livechat-config');\n      }\n\n      Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n        actionLinks: config.theme.actionLinks.jitsi\n      });\n      let rname;\n\n      if (rcSettings.get('Jitsi_URL_Room_Hash')) {\n        rname = rcSettings.get('uniqueID') + rid;\n      } else {\n        rname = encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n      }\n\n      const videoCall = {\n        rid,\n        domain: rcSettings.get('Jitsi_Domain'),\n        provider: 'jitsi',\n        room: rcSettings.get('Jitsi_URL_Room_Prefix') + rname + rcSettings.get('Jitsi_URL_Room_Suffix'),\n        timeout: new Date(Date.now() + 3600 * 1000)\n      };\n      return API.v1.success(this.deprecationWarning({\n        videoCall\n      }));\n    } catch (e) {\n      logger.error(e);\n      return API.v1.failure(e);\n    }\n  }\n\n});\nAPI.v1.addRoute('livechat/webrtc.call', {\n  authRequired: true\n}, {\n  get() {\n    try {\n      check(this.queryParams, {\n        rid: Match.Maybe(String)\n      });\n\n      if (!hasPermission(this.userId, 'view-l-room')) {\n        return API.v1.unauthorized();\n      }\n\n      const room = canSendMessage(this.queryParams.rid, {\n        uid: this.userId,\n        username: this.user.username,\n        type: this.user.type\n      });\n\n      if (!room) {\n        throw new Meteor.Error('invalid-room');\n      }\n\n      const webrtcCallingAllowed = rcSettings.get('WebRTC_Enabled') === true && rcSettings.get('Omnichannel_call_provider') === 'WebRTC';\n\n      if (!webrtcCallingAllowed) {\n        throw new Meteor.Error('webRTC calling not enabled');\n      }\n\n      const config = Promise.await(settings());\n\n      if (!config.theme || !config.theme.actionLinks || !config.theme.actionLinks.webrtc) {\n        throw new Meteor.Error('invalid-livechat-config');\n      }\n\n      let {\n        callStatus\n      } = room;\n\n      if (!callStatus || callStatus === 'ended' || callStatus === 'declined') {\n        callStatus = 'ringing';\n        Promise.await(Rooms.setCallStatusAndCallStartTime(room._id, callStatus));\n        Promise.await(Messages.createWithTypeRoomIdMessageAndUser('livechat_webrtc_video_call', room._id, TAPi18n.__('Join_my_room_to_start_the_video_call'), this.user, {\n          actionLinks: config.theme.actionLinks.webrtc\n        }));\n      }\n\n      const videoCall = {\n        rid: room._id,\n        provider: 'webrtc',\n        callStatus\n      };\n      return API.v1.success({\n        videoCall\n      });\n    } catch (e) {\n      logger.error(e);\n      return API.v1.failure(e);\n    }\n  }\n\n});\nAPI.v1.addRoute('livechat/webrtc.call/:callId', {\n  authRequired: true\n}, {\n  put() {\n    try {\n      check(this.urlParams, {\n        callId: String\n      });\n      check(this.bodyParams, {\n        rid: Match.Maybe(String),\n        status: Match.Maybe(String)\n      });\n      const {\n        callId\n      } = this.urlParams;\n      const {\n        rid,\n        status\n      } = this.bodyParams;\n\n      if (!hasPermission(this.userId, 'view-l-room')) {\n        return API.v1.unauthorized();\n      }\n\n      const room = canSendMessage(rid, {\n        uid: this.userId,\n        username: this.user.username,\n        type: this.user.type\n      });\n\n      if (!room) {\n        throw new Meteor.Error('invalid-room');\n      }\n\n      const call = Promise.await(Messages.findOneById(callId));\n\n      if (!call || call.t !== 'livechat_webrtc_video_call') {\n        throw new Meteor.Error('invalid-callId');\n      }\n\n      Livechat.updateCallStatus(callId, rid, status, this.user);\n      return API.v1.success({\n        status\n      });\n    } catch (e) {\n      logger.error(e);\n      return API.v1.failure(e);\n    }\n  }\n\n});","map":{"version":3,"sources":["app/livechat/server/api/v1/videoCall.js"],"names":["Meteor","module","link","v","Match","check","Random","TAPi18n","Messages","Rooms","rcSettings","settings","API","findGuest","getRoom","OmnichannelSourceType","hasPermission","canSendMessage","Livechat","Logger","logger","v1","addRoute","get","urlParams","token","String","queryParams","rid","Maybe","guest","Error","id","roomInfo","jitsiTimeout","Date","now","source","type","alias","room","config","Promise","await","theme","actionLinks","jitsi","createWithTypeRoomIdMessageAndUser","_id","rname","encodeURIComponent","t","usernames","join","name","videoCall","domain","provider","timeout","success","deprecationWarning","e","error","failure","authRequired","userId","unauthorized","uid","username","user","webrtcCallingAllowed","webrtc","callStatus","setCallStatusAndCallStartTime","__","put","callId","bodyParams","status","call","findOneById","updateCallStatus"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\nimport { Random } from 'meteor/random';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { Messages, Rooms } from '../../../../models';\nimport { settings as rcSettings } from '../../../../settings/server';\nimport { API } from '../../../../api/server';\nimport { findGuest, getRoom, settings } from '../lib/livechat';\nimport { OmnichannelSourceType } from '../../../../../definition/IRoom';\nimport { hasPermission, canSendMessage } from '../../../../authorization';\nimport { Livechat } from '../../lib/Livechat';\nimport { Logger } from '../../../../logger';\n\nconst logger = new Logger('LivechatVideoCallApi');\n\nAPI.v1.addRoute('livechat/video.call/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tcheck(this.queryParams, {\n\t\t\t\trid: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst { token } = this.urlParams;\n\n\t\t\tconst guest = findGuest(token);\n\t\t\tif (!guest) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst rid = this.queryParams.rid || Random.id();\n\t\t\tconst roomInfo = {\n\t\t\t\tjitsiTimeout: new Date(Date.now() + 3600 * 1000),\n\t\t\t\tsource: {\n\t\t\t\t\ttype: OmnichannelSourceType.API,\n\t\t\t\t\talias: 'video-call',\n\t\t\t\t},\n\t\t\t};\n\t\t\tconst { room } = getRoom({ guest, rid, roomInfo });\n\t\t\tconst config = Promise.await(settings());\n\t\t\tif (!config.theme || !config.theme.actionLinks || !config.theme.actionLinks.jitsi) {\n\t\t\t\tthrow new Meteor.Error('invalid-livechat-config');\n\t\t\t}\n\n\t\t\tMessages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\t\tactionLinks: config.theme.actionLinks.jitsi,\n\t\t\t});\n\t\t\tlet rname;\n\t\t\tif (rcSettings.get('Jitsi_URL_Room_Hash')) {\n\t\t\t\trname = rcSettings.get('uniqueID') + rid;\n\t\t\t} else {\n\t\t\t\trname = encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n\t\t\t}\n\t\t\tconst videoCall = {\n\t\t\t\trid,\n\t\t\t\tdomain: rcSettings.get('Jitsi_Domain'),\n\t\t\t\tprovider: 'jitsi',\n\t\t\t\troom: rcSettings.get('Jitsi_URL_Room_Prefix') + rname + rcSettings.get('Jitsi_URL_Room_Suffix'),\n\t\t\t\ttimeout: new Date(Date.now() + 3600 * 1000),\n\t\t\t};\n\n\t\t\treturn API.v1.success(this.deprecationWarning({ videoCall }));\n\t\t} catch (e) {\n\t\t\tlogger.error(e);\n\t\t\treturn API.v1.failure(e);\n\t\t}\n\t},\n});\n\nAPI.v1.addRoute(\n\t'livechat/webrtc.call',\n\t{ authRequired: true },\n\t{\n\t\tget() {\n\t\t\ttry {\n\t\t\t\tcheck(this.queryParams, {\n\t\t\t\t\trid: Match.Maybe(String),\n\t\t\t\t});\n\n\t\t\t\tif (!hasPermission(this.userId, 'view-l-room')) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\tconst room = canSendMessage(this.queryParams.rid, {\n\t\t\t\t\tuid: this.userId,\n\t\t\t\t\tusername: this.user.username,\n\t\t\t\t\ttype: this.user.type,\n\t\t\t\t});\n\t\t\t\tif (!room) {\n\t\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t\t}\n\n\t\t\t\tconst webrtcCallingAllowed = rcSettings.get('WebRTC_Enabled') === true && rcSettings.get('Omnichannel_call_provider') === 'WebRTC';\n\t\t\t\tif (!webrtcCallingAllowed) {\n\t\t\t\t\tthrow new Meteor.Error('webRTC calling not enabled');\n\t\t\t\t}\n\n\t\t\t\tconst config = Promise.await(settings());\n\t\t\t\tif (!config.theme || !config.theme.actionLinks || !config.theme.actionLinks.webrtc) {\n\t\t\t\t\tthrow new Meteor.Error('invalid-livechat-config');\n\t\t\t\t}\n\n\t\t\t\tlet { callStatus } = room;\n\n\t\t\t\tif (!callStatus || callStatus === 'ended' || callStatus === 'declined') {\n\t\t\t\t\tcallStatus = 'ringing';\n\t\t\t\t\tPromise.await(Rooms.setCallStatusAndCallStartTime(room._id, callStatus));\n\t\t\t\t\tPromise.await(\n\t\t\t\t\t\tMessages.createWithTypeRoomIdMessageAndUser(\n\t\t\t\t\t\t\t'livechat_webrtc_video_call',\n\t\t\t\t\t\t\troom._id,\n\t\t\t\t\t\t\tTAPi18n.__('Join_my_room_to_start_the_video_call'),\n\t\t\t\t\t\t\tthis.user,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tactionLinks: config.theme.actionLinks.webrtc,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tconst videoCall = {\n\t\t\t\t\trid: room._id,\n\t\t\t\t\tprovider: 'webrtc',\n\t\t\t\t\tcallStatus,\n\t\t\t\t};\n\t\t\t\treturn API.v1.success({ videoCall });\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error(e);\n\t\t\t\treturn API.v1.failure(e);\n\t\t\t}\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/webrtc.call/:callId',\n\t{ authRequired: true },\n\t{\n\t\tput() {\n\t\t\ttry {\n\t\t\t\tcheck(this.urlParams, {\n\t\t\t\t\tcallId: String,\n\t\t\t\t});\n\n\t\t\t\tcheck(this.bodyParams, {\n\t\t\t\t\trid: Match.Maybe(String),\n\t\t\t\t\tstatus: Match.Maybe(String),\n\t\t\t\t});\n\n\t\t\t\tconst { callId } = this.urlParams;\n\t\t\t\tconst { rid, status } = this.bodyParams;\n\n\t\t\t\tif (!hasPermission(this.userId, 'view-l-room')) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\tconst room = canSendMessage(rid, {\n\t\t\t\t\tuid: this.userId,\n\t\t\t\t\tusername: this.user.username,\n\t\t\t\t\ttype: this.user.type,\n\t\t\t\t});\n\t\t\t\tif (!room) {\n\t\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t\t}\n\n\t\t\t\tconst call = Promise.await(Messages.findOneById(callId));\n\t\t\t\tif (!call || call.t !== 'livechat_webrtc_video_call') {\n\t\t\t\t\tthrow new Meteor.Error('invalid-callId');\n\t\t\t\t}\n\n\t\t\t\tLivechat.updateCallStatus(callId, rid, status, this.user);\n\n\t\t\t\treturn API.v1.success({ status });\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error(e);\n\t\t\t\treturn API.v1.failure(e);\n\t\t\t}\n\t\t},\n\t},\n);\n"]},"sourceType":"module","hash":"dc3a9cbffc0373207eaccdb792cdabc9f1d2887c"}
