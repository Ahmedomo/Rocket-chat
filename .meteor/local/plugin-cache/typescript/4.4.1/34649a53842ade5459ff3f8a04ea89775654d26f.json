{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/createRoom.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/lib/server/functions/createRoom.ts","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/createRoom.ts","inputSourceMap":{"version":3,"file":"app/lib/server/functions/createRoom.ts","sourceRoot":"","sources":["app/lib/server/functions/createRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppsEngineException } from '@rocket.chat/apps-engine/definition/exceptions';\nimport { Meteor } from 'meteor/meteor';\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nimport { Apps } from '../../../apps/server';\nimport { addUserRoles } from '../../../../server/lib/roles/addUserRoles';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Messages, Rooms, Subscriptions, Users } from '../../../models/server';\nimport { getValidRoomName } from '../../../utils/server';\nimport { createDirectRoom } from './createDirectRoom';\nimport { Team } from '../../../../server/sdk';\nimport { IUser } from '../../../../definition/IUser';\nimport { ICreateRoomParams, ISubscriptionExtraData } from '../../../../server/sdk/types/IRoomService';\nimport { IRoom, RoomType } from '../../../../definition/IRoom';\n\nconst isValidName = (name: unknown): name is string => {\n\treturn typeof name === 'string' && s.trim(name).length > 0;\n};\n\nexport const createRoom = function <T extends RoomType>(\n\ttype: T,\n\tname: T extends 'd' ? undefined : string,\n\townerUsername: string,\n\tmembers: T extends 'd' ? IUser[] : string[] = [],\n\treadOnly?: boolean,\n\troomExtraData?: Partial<IRoom>,\n\toptions?: ICreateRoomParams['options'],\n): unknown {\n\tconst { teamId, ...extraData } = roomExtraData || ({} as IRoom);\n\tcallbacks.run('beforeCreateRoom', { type, name, owner: ownerUsername, members, readOnly, extraData, options });\n\n\tif (type === 'd') {\n\t\treturn createDirectRoom(members as IUser[], extraData, options);\n\t}\n\n\tif (!isValidName(name)) {\n\t\tthrow new Meteor.Error('error-invalid-name', 'Invalid name', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\tconst owner = Users.findOneByUsernameIgnoringCase(ownerUsername, { fields: { username: 1 } });\n\n\tif (!owner) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\tif (!_.contains(members, owner)) {\n\t\tmembers.push(owner.username);\n\t}\n\n\tif (extraData.broadcast) {\n\t\treadOnly = true;\n\t\tdelete extraData.reactWhenReadOnly;\n\t}\n\n\tconst now = new Date();\n\n\tconst roomProps: Omit<IRoom, '_id' | '_updatedAt' | 'uids' | 'jitsiTimeout' | 'autoTranslateLanguage'> = {\n\t\tfname: name,\n\t\t...extraData,\n\t\tname: getValidRoomName(name.trim(), undefined, {\n\t\t\t...(options?.nameValidationRegex && { nameValidationRegex: options.nameValidationRegex }),\n\t\t}),\n\t\tt: type,\n\t\tmsgs: 0,\n\t\tusersCount: 0,\n\t\tu: {\n\t\t\t_id: owner._id,\n\t\t\tusername: owner.username,\n\t\t},\n\t\tts: now,\n\t\tro: readOnly === true,\n\t};\n\n\tif (teamId) {\n\t\tconst team = Promise.await(Team.getOneById(teamId, { projection: { _id: 1 } }));\n\t\tif (team) {\n\t\t\troomProps.teamId = team._id;\n\t\t}\n\t}\n\n\tconst tmp = {\n\t\t...roomProps,\n\t\t_USERNAMES: members,\n\t};\n\n\tconst prevent = Promise.await(\n\t\tApps.triggerEvent('IPreRoomCreatePrevent', tmp).catch((error) => {\n\t\t\tif (error instanceof AppsEngineException) {\n\t\t\t\tthrow new Meteor.Error('error-app-prevented', error.message);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}),\n\t);\n\n\tif (prevent) {\n\t\tthrow new Meteor.Error('error-app-prevented', 'A Rocket.Chat App prevented the room creation.');\n\t}\n\n\tconst { _USERNAMES, ...result } = Promise.await(\n\t\tApps.triggerEvent('IPreRoomCreateModify', Promise.await(Apps.triggerEvent('IPreRoomCreateExtend', tmp))),\n\t);\n\n\tif (typeof result === 'object') {\n\t\tObject.assign(roomProps, result);\n\t}\n\n\tif (type === 'c') {\n\t\tcallbacks.run('beforeCreateChannel', owner, roomProps);\n\t}\n\tconst room = Rooms.createWithFullRoomData(roomProps);\n\n\tfor (const username of [...new Set(members as string[])]) {\n\t\tconst member = Users.findOneByUsername(username, {\n\t\t\tfields: { 'username': 1, 'settings.preferences': 1 },\n\t\t});\n\t\tif (!member) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst extra: Partial<ISubscriptionExtraData> = options?.subscriptionExtra || {};\n\n\t\textra.open = true;\n\n\t\tif (room.prid) {\n\t\t\textra.prid = room.prid;\n\t\t}\n\n\t\tif (username === owner.username) {\n\t\t\textra.ls = now;\n\t\t}\n\n\t\tSubscriptions.createWithRoomAndUser(room, member, extra);\n\t}\n\n\taddUserRoles(owner._id, ['owner'], room._id);\n\n\tif (type === 'c') {\n\t\tif (room.teamId) {\n\t\t\tconst team = Promise.await(Team.getOneById(room.teamId));\n\t\t\tteam && Messages.createUserAddRoomToTeamWithRoomIdAndUser(team.roomId, room.name, owner);\n\t\t}\n\t\tcallbacks.run('afterCreateChannel', owner, room);\n\t} else if (type === 'p') {\n\t\tcallbacks.runAsync('afterCreatePrivateGroup', owner, room);\n\t}\n\tcallbacks.runAsync('afterCreateRoom', owner, room);\n\n\tApps.triggerEvent('IPostRoomCreate', room);\n\n\treturn {\n\t\trid: room._id, // backwards compatible\n\t\t...room,\n\t};\n};\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/createRoom.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/createRoom.ts"}},"code":"const _excluded = [\"teamId\"],\n      _excluded2 = [\"_USERNAMES\"];\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 1);\nmodule.export({\n  createRoom: () => createRoom\n});\nlet AppsEngineException;\nmodule.link(\"@rocket.chat/apps-engine/definition/exceptions\", {\n  AppsEngineException(v) {\n    AppsEngineException = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 2);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 3);\nlet Apps;\nmodule.link(\"../../../apps/server\", {\n  Apps(v) {\n    Apps = v;\n  }\n\n}, 4);\nlet addUserRoles;\nmodule.link(\"../../../../server/lib/roles/addUserRoles\", {\n  addUserRoles(v) {\n    addUserRoles = v;\n  }\n\n}, 5);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 6);\nlet Messages, Rooms, Subscriptions, Users;\nmodule.link(\"../../../models/server\", {\n  Messages(v) {\n    Messages = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  },\n\n  Subscriptions(v) {\n    Subscriptions = v;\n  },\n\n  Users(v) {\n    Users = v;\n  }\n\n}, 7);\nlet getValidRoomName;\nmodule.link(\"../../../utils/server\", {\n  getValidRoomName(v) {\n    getValidRoomName = v;\n  }\n\n}, 8);\nlet createDirectRoom;\nmodule.link(\"./createDirectRoom\", {\n  createDirectRoom(v) {\n    createDirectRoom = v;\n  }\n\n}, 9);\nlet Team;\nmodule.link(\"../../../../server/sdk\", {\n  Team(v) {\n    Team = v;\n  }\n\n}, 10);\n\nconst isValidName = name => {\n  return typeof name === 'string' && s.trim(name).length > 0;\n};\n\nconst createRoom = function (type, name, ownerUsername) {\n  let members = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : [];\n  let readOnly = arguments.length > 4 ? arguments[4] : undefined;\n  let roomExtraData = arguments.length > 5 ? arguments[5] : undefined;\n  let options = arguments.length > 6 ? arguments[6] : undefined;\n\n  const _ref = roomExtraData || {},\n        {\n    teamId\n  } = _ref,\n        extraData = _objectWithoutProperties(_ref, _excluded);\n\n  callbacks.run('beforeCreateRoom', {\n    type,\n    name,\n    owner: ownerUsername,\n    members,\n    readOnly,\n    extraData,\n    options\n  });\n\n  if (type === 'd') {\n    return createDirectRoom(members, extraData, options);\n  }\n\n  if (!isValidName(name)) {\n    throw new Meteor.Error('error-invalid-name', 'Invalid name', {\n      function: 'RocketChat.createRoom'\n    });\n  }\n\n  const owner = Users.findOneByUsernameIgnoringCase(ownerUsername, {\n    fields: {\n      username: 1\n    }\n  });\n\n  if (!owner) {\n    throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n      function: 'RocketChat.createRoom'\n    });\n  }\n\n  if (!_.contains(members, owner)) {\n    members.push(owner.username);\n  }\n\n  if (extraData.broadcast) {\n    readOnly = true;\n    delete extraData.reactWhenReadOnly;\n  }\n\n  const now = new Date();\n\n  const roomProps = _objectSpread(_objectSpread({\n    fname: name\n  }, extraData), {}, {\n    name: getValidRoomName(name.trim(), undefined, _objectSpread({}, (options === null || options === void 0 ? void 0 : options.nameValidationRegex) && {\n      nameValidationRegex: options.nameValidationRegex\n    })),\n    t: type,\n    msgs: 0,\n    usersCount: 0,\n    u: {\n      _id: owner._id,\n      username: owner.username\n    },\n    ts: now,\n    ro: readOnly === true\n  });\n\n  if (teamId) {\n    const team = Promise.await(Team.getOneById(teamId, {\n      projection: {\n        _id: 1\n      }\n    }));\n\n    if (team) {\n      roomProps.teamId = team._id;\n    }\n  }\n\n  const tmp = _objectSpread(_objectSpread({}, roomProps), {}, {\n    _USERNAMES: members\n  });\n\n  const prevent = Promise.await(Apps.triggerEvent('IPreRoomCreatePrevent', tmp).catch(error => {\n    if (error instanceof AppsEngineException) {\n      throw new Meteor.Error('error-app-prevented', error.message);\n    }\n\n    throw error;\n  }));\n\n  if (prevent) {\n    throw new Meteor.Error('error-app-prevented', 'A Rocket.Chat App prevented the room creation.');\n  }\n\n  const _Promise$await = Promise.await(Apps.triggerEvent('IPreRoomCreateModify', Promise.await(Apps.triggerEvent('IPreRoomCreateExtend', tmp)))),\n        {\n    _USERNAMES\n  } = _Promise$await,\n        result = _objectWithoutProperties(_Promise$await, _excluded2);\n\n  if (typeof result === 'object') {\n    Object.assign(roomProps, result);\n  }\n\n  if (type === 'c') {\n    callbacks.run('beforeCreateChannel', owner, roomProps);\n  }\n\n  const room = Rooms.createWithFullRoomData(roomProps);\n\n  for (const username of [...new Set(members)]) {\n    const member = Users.findOneByUsername(username, {\n      fields: {\n        'username': 1,\n        'settings.preferences': 1\n      }\n    });\n\n    if (!member) {\n      continue;\n    }\n\n    const extra = (options === null || options === void 0 ? void 0 : options.subscriptionExtra) || {};\n    extra.open = true;\n\n    if (room.prid) {\n      extra.prid = room.prid;\n    }\n\n    if (username === owner.username) {\n      extra.ls = now;\n    }\n\n    Subscriptions.createWithRoomAndUser(room, member, extra);\n  }\n\n  addUserRoles(owner._id, ['owner'], room._id);\n\n  if (type === 'c') {\n    if (room.teamId) {\n      const team = Promise.await(Team.getOneById(room.teamId));\n      team && Messages.createUserAddRoomToTeamWithRoomIdAndUser(team.roomId, room.name, owner);\n    }\n\n    callbacks.run('afterCreateChannel', owner, room);\n  } else if (type === 'p') {\n    callbacks.runAsync('afterCreatePrivateGroup', owner, room);\n  }\n\n  callbacks.runAsync('afterCreateRoom', owner, room);\n  Apps.triggerEvent('IPostRoomCreate', room);\n  return _objectSpread({\n    rid: room._id\n  }, room);\n};","map":{"version":3,"sources":["app/lib/server/functions/createRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppsEngineException } from '@rocket.chat/apps-engine/definition/exceptions';\nimport { Meteor } from 'meteor/meteor';\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nimport { Apps } from '../../../apps/server';\nimport { addUserRoles } from '../../../../server/lib/roles/addUserRoles';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Messages, Rooms, Subscriptions, Users } from '../../../models/server';\nimport { getValidRoomName } from '../../../utils/server';\nimport { createDirectRoom } from './createDirectRoom';\nimport { Team } from '../../../../server/sdk';\nimport { IUser } from '../../../../definition/IUser';\nimport { ICreateRoomParams, ISubscriptionExtraData } from '../../../../server/sdk/types/IRoomService';\nimport { IRoom, RoomType } from '../../../../definition/IRoom';\n\nconst isValidName = (name: unknown): name is string => {\n\treturn typeof name === 'string' && s.trim(name).length > 0;\n};\n\nexport const createRoom = function <T extends RoomType>(\n\ttype: T,\n\tname: T extends 'd' ? undefined : string,\n\townerUsername: string,\n\tmembers: T extends 'd' ? IUser[] : string[] = [],\n\treadOnly?: boolean,\n\troomExtraData?: Partial<IRoom>,\n\toptions?: ICreateRoomParams['options'],\n): unknown {\n\tconst { teamId, ...extraData } = roomExtraData || ({} as IRoom);\n\tcallbacks.run('beforeCreateRoom', { type, name, owner: ownerUsername, members, readOnly, extraData, options });\n\n\tif (type === 'd') {\n\t\treturn createDirectRoom(members as IUser[], extraData, options);\n\t}\n\n\tif (!isValidName(name)) {\n\t\tthrow new Meteor.Error('error-invalid-name', 'Invalid name', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\tconst owner = Users.findOneByUsernameIgnoringCase(ownerUsername, { fields: { username: 1 } });\n\n\tif (!owner) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\tif (!_.contains(members, owner)) {\n\t\tmembers.push(owner.username);\n\t}\n\n\tif (extraData.broadcast) {\n\t\treadOnly = true;\n\t\tdelete extraData.reactWhenReadOnly;\n\t}\n\n\tconst now = new Date();\n\n\tconst roomProps: Omit<IRoom, '_id' | '_updatedAt' | 'uids' | 'jitsiTimeout' | 'autoTranslateLanguage'> = {\n\t\tfname: name,\n\t\t...extraData,\n\t\tname: getValidRoomName(name.trim(), undefined, {\n\t\t\t...(options?.nameValidationRegex && { nameValidationRegex: options.nameValidationRegex }),\n\t\t}),\n\t\tt: type,\n\t\tmsgs: 0,\n\t\tusersCount: 0,\n\t\tu: {\n\t\t\t_id: owner._id,\n\t\t\tusername: owner.username,\n\t\t},\n\t\tts: now,\n\t\tro: readOnly === true,\n\t};\n\n\tif (teamId) {\n\t\tconst team = Promise.await(Team.getOneById(teamId, { projection: { _id: 1 } }));\n\t\tif (team) {\n\t\t\troomProps.teamId = team._id;\n\t\t}\n\t}\n\n\tconst tmp = {\n\t\t...roomProps,\n\t\t_USERNAMES: members,\n\t};\n\n\tconst prevent = Promise.await(\n\t\tApps.triggerEvent('IPreRoomCreatePrevent', tmp).catch((error) => {\n\t\t\tif (error instanceof AppsEngineException) {\n\t\t\t\tthrow new Meteor.Error('error-app-prevented', error.message);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}),\n\t);\n\n\tif (prevent) {\n\t\tthrow new Meteor.Error('error-app-prevented', 'A Rocket.Chat App prevented the room creation.');\n\t}\n\n\tconst { _USERNAMES, ...result } = Promise.await(\n\t\tApps.triggerEvent('IPreRoomCreateModify', Promise.await(Apps.triggerEvent('IPreRoomCreateExtend', tmp))),\n\t);\n\n\tif (typeof result === 'object') {\n\t\tObject.assign(roomProps, result);\n\t}\n\n\tif (type === 'c') {\n\t\tcallbacks.run('beforeCreateChannel', owner, roomProps);\n\t}\n\tconst room = Rooms.createWithFullRoomData(roomProps);\n\n\tfor (const username of [...new Set(members as string[])]) {\n\t\tconst member = Users.findOneByUsername(username, {\n\t\t\tfields: { 'username': 1, 'settings.preferences': 1 },\n\t\t});\n\t\tif (!member) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst extra: Partial<ISubscriptionExtraData> = options?.subscriptionExtra || {};\n\n\t\textra.open = true;\n\n\t\tif (room.prid) {\n\t\t\textra.prid = room.prid;\n\t\t}\n\n\t\tif (username === owner.username) {\n\t\t\textra.ls = now;\n\t\t}\n\n\t\tSubscriptions.createWithRoomAndUser(room, member, extra);\n\t}\n\n\taddUserRoles(owner._id, ['owner'], room._id);\n\n\tif (type === 'c') {\n\t\tif (room.teamId) {\n\t\t\tconst team = Promise.await(Team.getOneById(room.teamId));\n\t\t\tteam && Messages.createUserAddRoomToTeamWithRoomIdAndUser(team.roomId, room.name, owner);\n\t\t}\n\t\tcallbacks.run('afterCreateChannel', owner, room);\n\t} else if (type === 'p') {\n\t\tcallbacks.runAsync('afterCreatePrivateGroup', owner, room);\n\t}\n\tcallbacks.runAsync('afterCreateRoom', owner, room);\n\n\tApps.triggerEvent('IPostRoomCreate', room);\n\n\treturn {\n\t\trid: room._id, // backwards compatible\n\t\t...room,\n\t};\n};\n"],"sourceRoot":""},"sourceType":"module","hash":"34649a53842ade5459ff3f8a04ea89775654d26f"}
