{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/setEmail.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/lib/server/functions/setEmail.ts","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/setEmail.ts","inputSourceMap":{"version":3,"file":"app/lib/server/functions/setEmail.ts","sourceRoot":"","sources":["app/lib/server/functions/setEmail.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/explicit-function-return-type */\nimport { Meteor } from 'meteor/meteor';\nimport s from 'underscore.string';\nimport { escapeHTML } from '@rocket.chat/string-helpers';\n\nimport { Users } from '../../../models/server';\nimport { hasPermission } from '../../../authorization/server';\nimport { RateLimiter, validateEmailDomain } from '../lib';\nimport * as Mailer from '../../../mailer';\nimport { settings } from '../../../settings/server';\nimport { checkEmailAvailability } from '.';\n\nlet html = '';\nMeteor.startup(() => {\n\tMailer.getTemplate('Email_Changed_Email', (template) => {\n\t\thtml = template;\n\t});\n});\n\nconst _sendEmailChangeNotification = function (to: string, newEmail: string) {\n\tconst subject = String(settings.get('Email_Changed_Email_Subject'));\n\tconst email = {\n\t\tto,\n\t\tfrom: String(settings.get('From_Email')),\n\t\tsubject,\n\t\thtml,\n\t\tdata: {\n\t\t\temail: escapeHTML(newEmail),\n\t\t},\n\t};\n\n\ttry {\n\t\tMailer.send(email);\n\t} catch (error: any) {\n\t\tthrow new Meteor.Error('error-email-send-failed', `Error trying to send email: ${error.message}`, {\n\t\t\tfunction: 'setEmail',\n\t\t\tmessage: error.message,\n\t\t});\n\t}\n};\n\nconst _setEmail = function (userId: string, email: string, shouldSendVerificationEmail = true) {\n\temail = s.trim(email);\n\tif (!userId) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { function: '_setEmail' });\n\t}\n\n\tif (!email) {\n\t\tthrow new Meteor.Error('error-invalid-email', 'Invalid email', { function: '_setEmail' });\n\t}\n\n\tvalidateEmailDomain(email);\n\n\tconst user = Users.findOneById(userId);\n\n\t// User already has desired username, return\n\tif (user.emails && user.emails[0] && user.emails[0].address === email) {\n\t\treturn user;\n\t}\n\n\t// Check email availability\n\tif (!checkEmailAvailability(email)) {\n\t\tthrow new Meteor.Error('error-field-unavailable', `${email} is already in use :(`, {\n\t\t\tfunction: '_setEmail',\n\t\t\tfield: email,\n\t\t});\n\t}\n\n\tconst oldEmail = user.emails && user.emails[0];\n\n\tif (oldEmail) {\n\t\t_sendEmailChangeNotification(oldEmail.address, email);\n\t}\n\n\t// Set new email\n\tUsers.setEmail(user._id, email);\n\tuser.email = email;\n\tif (shouldSendVerificationEmail === true) {\n\t\tMeteor.call('sendConfirmationEmail', user.email);\n\t}\n\treturn user;\n};\n\nexport const setEmail = RateLimiter.limitFunction(_setEmail, 1, 60000, {\n\t0() {\n\t\tconst userId = Meteor.userId();\n\t\treturn !userId || !hasPermission(userId, 'edit-other-user-info');\n\t}, // Administrators have permission to change others emails, so don't limit those\n});\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/setEmail.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/setEmail.ts"}},"code":"module.export({\n  setEmail: () => setEmail\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 1);\nlet escapeHTML;\nmodule.link(\"@rocket.chat/string-helpers\", {\n  escapeHTML(v) {\n    escapeHTML = v;\n  }\n\n}, 2);\nlet Users;\nmodule.link(\"../../../models/server\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 3);\nlet hasPermission;\nmodule.link(\"../../../authorization/server\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 4);\nlet RateLimiter, validateEmailDomain;\nmodule.link(\"../lib\", {\n  RateLimiter(v) {\n    RateLimiter = v;\n  },\n\n  validateEmailDomain(v) {\n    validateEmailDomain = v;\n  }\n\n}, 5);\nlet Mailer;\nmodule.link(\"../../../mailer\", {\n  \"*\"(v) {\n    Mailer = v;\n  }\n\n}, 6);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 7);\nlet checkEmailAvailability;\nmodule.link(\".\", {\n  checkEmailAvailability(v) {\n    checkEmailAvailability = v;\n  }\n\n}, 8);\nlet html = '';\nMeteor.startup(() => {\n  Mailer.getTemplate('Email_Changed_Email', template => {\n    html = template;\n  });\n});\n\nconst _sendEmailChangeNotification = function (to, newEmail) {\n  const subject = String(settings.get('Email_Changed_Email_Subject'));\n  const email = {\n    to,\n    from: String(settings.get('From_Email')),\n    subject,\n    html,\n    data: {\n      email: escapeHTML(newEmail)\n    }\n  };\n\n  try {\n    Mailer.send(email);\n  } catch (error) {\n    throw new Meteor.Error('error-email-send-failed', \"Error trying to send email: \".concat(error.message), {\n      function: 'setEmail',\n      message: error.message\n    });\n  }\n};\n\nconst _setEmail = function (userId, email) {\n  let shouldSendVerificationEmail = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;\n  email = s.trim(email);\n\n  if (!userId) {\n    throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n      function: '_setEmail'\n    });\n  }\n\n  if (!email) {\n    throw new Meteor.Error('error-invalid-email', 'Invalid email', {\n      function: '_setEmail'\n    });\n  }\n\n  validateEmailDomain(email);\n  const user = Users.findOneById(userId); // User already has desired username, return\n\n  if (user.emails && user.emails[0] && user.emails[0].address === email) {\n    return user;\n  } // Check email availability\n\n\n  if (!checkEmailAvailability(email)) {\n    throw new Meteor.Error('error-field-unavailable', \"\".concat(email, \" is already in use :(\"), {\n      function: '_setEmail',\n      field: email\n    });\n  }\n\n  const oldEmail = user.emails && user.emails[0];\n\n  if (oldEmail) {\n    _sendEmailChangeNotification(oldEmail.address, email);\n  } // Set new email\n\n\n  Users.setEmail(user._id, email);\n  user.email = email;\n\n  if (shouldSendVerificationEmail === true) {\n    Meteor.call('sendConfirmationEmail', user.email);\n  }\n\n  return user;\n};\n\nconst setEmail = RateLimiter.limitFunction(_setEmail, 1, 60000, {\n  0() {\n    const userId = Meteor.userId();\n    return !userId || !hasPermission(userId, 'edit-other-user-info');\n  } // Administrators have permission to change others emails, so don't limit those\n\n\n});","map":{"version":3,"sources":["app/lib/server/functions/setEmail.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/explicit-function-return-type */\nimport { Meteor } from 'meteor/meteor';\nimport s from 'underscore.string';\nimport { escapeHTML } from '@rocket.chat/string-helpers';\n\nimport { Users } from '../../../models/server';\nimport { hasPermission } from '../../../authorization/server';\nimport { RateLimiter, validateEmailDomain } from '../lib';\nimport * as Mailer from '../../../mailer';\nimport { settings } from '../../../settings/server';\nimport { checkEmailAvailability } from '.';\n\nlet html = '';\nMeteor.startup(() => {\n\tMailer.getTemplate('Email_Changed_Email', (template) => {\n\t\thtml = template;\n\t});\n});\n\nconst _sendEmailChangeNotification = function (to: string, newEmail: string) {\n\tconst subject = String(settings.get('Email_Changed_Email_Subject'));\n\tconst email = {\n\t\tto,\n\t\tfrom: String(settings.get('From_Email')),\n\t\tsubject,\n\t\thtml,\n\t\tdata: {\n\t\t\temail: escapeHTML(newEmail),\n\t\t},\n\t};\n\n\ttry {\n\t\tMailer.send(email);\n\t} catch (error: any) {\n\t\tthrow new Meteor.Error('error-email-send-failed', `Error trying to send email: ${error.message}`, {\n\t\t\tfunction: 'setEmail',\n\t\t\tmessage: error.message,\n\t\t});\n\t}\n};\n\nconst _setEmail = function (userId: string, email: string, shouldSendVerificationEmail = true) {\n\temail = s.trim(email);\n\tif (!userId) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { function: '_setEmail' });\n\t}\n\n\tif (!email) {\n\t\tthrow new Meteor.Error('error-invalid-email', 'Invalid email', { function: '_setEmail' });\n\t}\n\n\tvalidateEmailDomain(email);\n\n\tconst user = Users.findOneById(userId);\n\n\t// User already has desired username, return\n\tif (user.emails && user.emails[0] && user.emails[0].address === email) {\n\t\treturn user;\n\t}\n\n\t// Check email availability\n\tif (!checkEmailAvailability(email)) {\n\t\tthrow new Meteor.Error('error-field-unavailable', `${email} is already in use :(`, {\n\t\t\tfunction: '_setEmail',\n\t\t\tfield: email,\n\t\t});\n\t}\n\n\tconst oldEmail = user.emails && user.emails[0];\n\n\tif (oldEmail) {\n\t\t_sendEmailChangeNotification(oldEmail.address, email);\n\t}\n\n\t// Set new email\n\tUsers.setEmail(user._id, email);\n\tuser.email = email;\n\tif (shouldSendVerificationEmail === true) {\n\t\tMeteor.call('sendConfirmationEmail', user.email);\n\t}\n\treturn user;\n};\n\nexport const setEmail = RateLimiter.limitFunction(_setEmail, 1, 60000, {\n\t0() {\n\t\tconst userId = Meteor.userId();\n\t\treturn !userId || !hasPermission(userId, 'edit-other-user-info');\n\t}, // Administrators have permission to change others emails, so don't limit those\n});\n"],"sourceRoot":""},"sourceType":"module","hash":"7b0008f2089885fc9143151e580a117e86756a7e"}
